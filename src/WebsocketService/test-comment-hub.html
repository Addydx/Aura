<!DOCTYPE html>
<html>
<head>
    <title>Aura CommentHub Test</title>
    <script src="https://unpkg.com/@microsoft/signalr@8.0.0/dist/browser/signalr.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 20px; background: #f5f5f5; }
        .container { max-width: 1000px; margin: 0 auto; }
        h1 { color: #333; }
        .section { background: white; border-radius: 8px; padding: 20px; margin: 15px 0; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .status { padding: 10px; border-radius: 5px; margin: 10px 0; }
        .status.connected { background: #d4edda; color: #155724; }
        .status.disconnected { background: #f8d7da; color: #721c24; }
        button { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 5px; }
        button:hover { background: #0056b3; }
        button.danger { background: #dc3545; }
        button.danger:hover { background: #c82333; }
        input, textarea { padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin: 5px; width: calc(100% - 20px); }
        .comments-area { min-height: 300px; max-height: 500px; overflow-y: auto; border: 1px solid #ddd; padding: 15px; background: #fafafa; border-radius: 5px; }
        .comment { background: white; padding: 10px; margin: 10px 0; border-left: 3px solid #007bff; border-radius: 3px; }
        .comment.own { border-left-color: #28a745; }
        .typing-indicator { color: #6c757d; font-style: italic; padding: 5px; }
        .reaction { display: inline-block; padding: 3px 8px; background: #e9ecef; border-radius: 12px; margin: 2px; cursor: pointer; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        @media (max-width: 768px) { .grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <div class="container">
        <h1>üí¨ Aura CommentHub Test</h1>
        
        <div class="section">
            <h3>üîå Conexi√≥n</h3>
            <div id="connectionStatus" class="status disconnected">Desconectado</div>
            <button onclick="connect()">Conectar</button>
            <button onclick="disconnect()" class="danger">Desconectar</button>
        </div>

        <div class="grid">
            <div class="section">
                <h3>üë§ Configuraci√≥n Usuario</h3>
                <input type="text" id="userId" placeholder="User ID" value="user_123">
                <input type="text" id="username" placeholder="Username" value="Juan P√©rez">
            </div>

            <div class="section">
                <h3>üñºÔ∏è Imagen</h3>
                <input type="text" id="imageId" placeholder="Image ID" value="383e8d66-3856-457b-b56f-996dbfcfd912">
                <button onclick="subscribeToImage()">üìå Suscribirse</button>
                <button onclick="unsubscribeFromImage()" class="danger">üö™ Desuscribirse</button>
            </div>
        </div>

        <div class="section">
            <h3>üí¨ Nuevo Comentario</h3>
            <textarea id="commentText" placeholder="Escribe tu comentario aqu√≠..." rows="3"></textarea>
            <div>
                <button onclick="startTyping()">‚å®Ô∏è Indicar que estoy escribiendo</button>
                <button onclick="stopTyping()">‚úã Dejar de escribir</button>
            </div>
            <div id="typingIndicators" class="typing-indicator"></div>
        </div>

        <div class="section">
            <h3>üìù Comentarios</h3>
            <div id="commentsArea" class="comments-area">
                <p style="text-align: center; color: #999;">Los comentarios aparecer√°n aqu√≠ en tiempo real...</p>
            </div>
        </div>

        <div class="section">
            <h3>üß™ Acciones de Prueba</h3>
            <div>
                <input type="text" id="commentId" placeholder="Comment ID" value="comment123">
                <button onclick="likeComment()">üëç Like</button>
                <button onclick="loveComment()">‚ù§Ô∏è Love</button>
                <button onclick="testDeleteComment()" class="danger">üóëÔ∏è Eliminar</button>
            </div>
        </div>

        <div class="section">
            <h3>üìä Logs</h3>
            <div id="logs" style="max-height: 200px; overflow-y: auto; font-family: monospace; font-size: 12px; background: #f8f9fa; padding: 10px; border-radius: 5px;">
                <div>Esperando conexi√≥n...</div>
            </div>
            <button onclick="clearLogs()">üßπ Limpiar Logs</button>
        </div>
    </div>

    <script>
        let connection;
        let typingUsers = new Set();

        async function connect() {
            connection = new signalR.HubConnectionBuilder()
                .withUrl("http://localhost:5250/commentHub")
                .withAutomaticReconnect()
                .build();

            // Event: Connected
            connection.on("Connected", (data) => {
                log(`‚úÖ Conectado: ${JSON.stringify(data)}`, 'success');
                updateConnectionStatus(true);
            });

            // Event: SubscriptionConfirmed
            connection.on("SubscriptionConfirmed", (data) => {
                log(`üìå Suscripci√≥n confirmada: ${data.ImageId}`, 'info');
            });

            // Event: UnsubscriptionConfirmed
            connection.on("UnsubscriptionConfirmed", (data) => {
                log(`üö™ Desuscripci√≥n confirmada: ${data.ImageId}`, 'info');
            });

            // Event: NewComment
            connection.on("NewComment", (comment) => {
                log(`üí¨ Nuevo comentario recibido`, 'comment');
                addComment(comment);
            });

            // Event: UserTyping
            connection.on("UserTyping", (data) => {
                typingUsers.add(data.Username);
                updateTypingIndicator();
            });

            // Event: UserStoppedTyping
            connection.on("UserStoppedTyping", (data) => {
                typingUsers.delete(data.Username);
                updateTypingIndicator();
            });

            // Event: CommentReaction
            connection.on("CommentReaction", (data) => {
                log(`${data.ReactionType} en comentario ${data.CommentId}`, 'reaction');
            });

            // Event: CommentDeleted
            connection.on("CommentDeleted", (data) => {
                log(`üóëÔ∏è Comentario eliminado: ${data.CommentId}`, 'warning');
                removeComment(data.CommentId);
            });

            // Event: CommentEdited
            connection.on("CommentEdited", (data) => {
                log(`‚úèÔ∏è Comentario editado: ${data.CommentId}`, 'info');
            });

            try {
                await connection.start();
                log("üéâ Conexi√≥n establecida exitosamente", 'success');
            } catch (err) {
                log(`‚ùå Error de conexi√≥n: ${err}`, 'error');
                updateConnectionStatus(false);
            }

            connection.onreconnecting((error) => {
                log(`‚ö†Ô∏è Reconectando... ${error}`, 'warning');
            });

            connection.onreconnected((connectionId) => {
                log(`‚úÖ Reconectado: ${connectionId}`, 'success');
            });

            connection.onclose((error) => {
                log(`üîå Conexi√≥n cerrada`, 'error');
                updateConnectionStatus(false);
            });
        }

        async function disconnect() {
            if (connection) {
                await connection.stop();
                log("üîå Desconectado manualmente", 'info');
            }
        }

        async function subscribeToImage() {
            const imageId = document.getElementById('imageId').value;
            if (connection && imageId) {
                await connection.invoke("SubscribeToImage", imageId);
            }
        }

        async function unsubscribeFromImage() {
            const imageId = document.getElementById('imageId').value;
            if (connection && imageId) {
                await connection.invoke("UnsubscribeFromImage", imageId);
            }
        }

        async function startTyping() {
            const imageId = document.getElementById('imageId').value;
            const userId = document.getElementById('userId').value;
            const username = document.getElementById('username').value;
            
            if (connection && imageId && userId) {
                await connection.invoke("UserTyping", imageId, userId, username);
                log(`‚å®Ô∏è Indicado que est√°s escribiendo`, 'info');
            }
        }

        async function stopTyping() {
            const imageId = document.getElementById('imageId').value;
            const userId = document.getElementById('userId').value;
            
            if (connection && imageId && userId) {
                await connection.invoke("UserStoppedTyping", imageId, userId);
                log(`‚úã Indicado que dejaste de escribir`, 'info');
            }
        }

        async function likeComment() {
            const imageId = document.getElementById('imageId').value;
            const commentId = document.getElementById('commentId').value;
            const userId = document.getElementById('userId').value;
            
            if (connection) {
                await connection.invoke("ReactToComment", imageId, commentId, userId, "like");
            }
        }

        async function loveComment() {
            const imageId = document.getElementById('imageId').value;
            const commentId = document.getElementById('commentId').value;
            const userId = document.getElementById('userId').value;
            
            if (connection) {
                await connection.invoke("ReactToComment", imageId, commentId, userId, "love");
            }
        }

        async function testDeleteComment() {
            const imageId = document.getElementById('imageId').value;
            const commentId = document.getElementById('commentId').value;
            
            if (connection && confirm('¬øEliminar comentario de prueba?')) {
                await connection.invoke("NotifyCommentDeleted", imageId, commentId);
            }
        }

        function addComment(comment) {
            const commentsArea = document.getElementById('commentsArea');
            const commentDiv = document.createElement('div');
            commentDiv.className = 'comment';
            commentDiv.id = `comment_${comment.CommentId}`;
            commentDiv.innerHTML = `
                <strong>Usuario: ${comment.UserId}</strong><br>
                <p>${comment.Content}</p>
                <small>${new Date(comment.CreatedAt).toLocaleString()}</small>
            `;
            commentsArea.appendChild(commentDiv);
            commentsArea.scrollTop = commentsArea.scrollHeight;
        }

        function removeComment(commentId) {
            const comment = document.getElementById(`comment_${commentId}`);
            if (comment) {
                comment.style.opacity = '0.3';
                comment.style.textDecoration = 'line-through';
            }
        }

        function updateTypingIndicator() {
            const indicator = document.getElementById('typingIndicators');
            if (typingUsers.size > 0) {
                const users = Array.from(typingUsers).join(', ');
                indicator.textContent = `${users} est√° escribiendo...`;
            } else {
                indicator.textContent = '';
            }
        }

        function updateConnectionStatus(connected) {
            const statusDiv = document.getElementById('connectionStatus');
            if (connected) {
                statusDiv.textContent = '‚úÖ Conectado al CommentHub';
                statusDiv.className = 'status connected';
            } else {
                statusDiv.textContent = '‚ùå Desconectado';
                statusDiv.className = 'status disconnected';
            }
        }

        function log(message, type = 'info') {
            const logs = document.getElementById('logs');
            const logEntry = document.createElement('div');
            logEntry.style.color = type === 'error' ? 'red' : 
                                   type === 'success' ? 'green' : 
                                   type === 'warning' ? 'orange' : 
                                   type === 'comment' ? 'blue' : 'black';
            logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logs.appendChild(logEntry);
            logs.scrollTop = logs.scrollHeight;
        }

        function clearLogs() {
            document.getElementById('logs').innerHTML = '';
        }

        // Auto-typing simulation
        let typingTimeout;
        document.getElementById('commentText').addEventListener('input', () => {
            clearTimeout(typingTimeout);
            startTyping();
            typingTimeout = setTimeout(stopTyping, 3000);
        });
    </script>
</body>
</html>